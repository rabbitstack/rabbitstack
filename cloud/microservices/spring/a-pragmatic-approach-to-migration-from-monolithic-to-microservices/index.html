<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>A pragmatic approach to migration from monolithic to microservices &#8211; Rabbit Stack</title>
<meta name="description" content="If you recall from this post, I had stated about cloud native  manifesto and the tradeoff of migrating the monolithic based applications to the cloud. I have to admit it was pretty abstract and theoretical approach...">
<meta name="keywords" content="spring cloud, spring boot, netflix, eureka, microservices, circuit breaker, zuul, hystrix, monolithic, discovery, consul, golang, go-kit">



<!-- Twitter Cards -->
<meta name="twitter:title" content="A pragmatic approach to migration from monolithic to microservices">
<meta name="twitter:description" content="If you recall from this post, I had stated about cloud native  manifesto and the tradeoff of migrating the monolithic based applications to the cloud. I have to admit it was pretty abstract and theoretical approach...">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://rabbitstack.github.io/images/rabbit-bkgd.jpg">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="A pragmatic approach to migration from monolithic to microservices">
<meta property="og:description" content="If you recall from this post, I had stated about cloud native  manifesto and the tradeoff of migrating the monolithic based applications to the cloud. I have to admit it was pretty abstract and theoretical approach...">
<meta property="og:url" content="http://rabbitstack.github.io/cloud/microservices/spring/a-pragmatic-approach-to-migration-from-monolithic-to-microservices/">
<meta property="og:site_name" content="Rabbit Stack">





<link rel="canonical" href="http://rabbitstack.github.io/cloud/microservices/spring/a-pragmatic-approach-to-migration-from-monolithic-to-microservices/">
<link href="http://rabbitstack.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="Rabbit Stack Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://rabbitstack.github.io/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://rabbitstack.github.io/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://rabbitstack.github.io/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://rabbitstack.github.io/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://rabbitstack.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://rabbitstack.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://rabbitstack.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://rabbitstack.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://rabbitstack.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://rabbitstack.github.io/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
		<div class="site-name">
			<!-- <img src="/images/rabbit-small.jpg" alt="Rabbit Stack logo" class="logo" /> -->
			<!-- <a href="http://rabbitstack.github.io/">Rabbit Stack</a> -->
			<a href="http://rabbitstack.github.io/"><span class="site-name-segment">Rabbit</span> <span class="big-font">Stack</span></a>

		</div><!-- /.site-name -->

	
	
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				        
				    
				    <li><a href="http://rabbitstack.github.io#" >Home</a></li>
				
				    
				        
				    
				    <li><a href="http://rabbitstack.github.io/posts/" >Archive</a></li>
				
				    
				        
				    
				    <li><a href="http://rabbitstack.github.io/about/" >About</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->


  <div class="image-wrap">
  <img class="bkg" src=
    
      "http://rabbitstack.github.io/images/rabbit-bkgd.jpg"
    
  alt="A pragmatic approach to migration from monolithic to microservices feature image">
  
       <div class="headline-wrap">
          <img src="http://rabbitstack.github.io/images/rabbitstack.png" />
          <h1> The place where bunnies dwell </h1>
          <h2> And bits become colossal </h2>
      </div>
  </div><!-- /.image-wrap -->


<div id="main" role="main">
  <div class="article-author-side">
    


<div itemscope itemtype="http://schema.org/Person">


	<img src="http://rabbitstack.github.io/images/nedo.jpg" class="bio-photo" alt="Nedim Šabić bio photo">


  <h3 itemprop="name">Nedim Šabić</h3>
  <p>Senior software engineer, devops enthusiast and platform architect who is also very curious about OS design, internals and implementation. Falling in love with Go language and idiomatic sugars of Ruby, although he is more experienced in Python, J2EE platform and Spring framework ecosystem for development of distributed and event processing solutions. He never stops learning, and at the moment he is reading a lot about Big data, machine learning, virtualization and cloud technologies.</p>
  <a href="mailto:bhnedo@hotmail.com" class="author-social" target="_blank"><i class="fa fa-fw fa-envelope-square"></i>Email</a>
  
  <a href="http://facebook.com/nedim.sabic.39" class="author-social" target="_blank"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a>
  
  <a href="https://es.linkedin.com/pub/nedim-šabić/107/435/8a6" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a>
  
  
  <a href="http://github.com/bhnedo" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  <a href="http://stackoverflow.com/users/1027467/nedo" class="author-social" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> Stackoverflow</a>
  
  
  
  
  
  
  <a href="http://soundcloud.com/nedim-abi" class="author-social" target="_blank"><i class="fa fa-fw fa-soundcloud"></i> Soundcloud</a>
  
  
</div>

  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://rabbitstack.github.io/cloud/microservices/spring/a-pragmatic-approach-to-migration-from-monolithic-to-microservices/" rel="bookmark" title="A pragmatic approach to migration from monolithic to microservices">A pragmatic approach to migration from monolithic to microservices</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>If you recall from <a href="http://rabbitstack.github.io/cloud/microservices/from-monolithic-to-cloud-native-architectures">this</a> post, I had stated about cloud native manifesto and the trade-off of migrating the monolithic based applications to the cloud. I have to admit it was pretty abstract and theoretical approach, but the fun starts now! We’ll see how to decompose a simple monolithic application (an already implemented <em>todo</em> list management web application) into independent services to deliver the microservice oriented architecture.</p>

<h3 id="defining-the-bounded-contexts">Defining the bounded contexts</h3>
<p>When migrating a monolithic code base the first step is to identify the <strong>bounded contexts</strong>. If you are familiar with <strong>DDD</strong> you should also know about the after-mentioned concept. Every bounded context should be encapsulated by a separate microservice where every of them must have an independent data store. In our case that’s an unique microservice which will offer the needed business logic (the management of <em>todo</em> lists). In a complex real world application there would be a dozen of microservices. Think about a big online store platform. We could create a microservice responsible for product operations, one for the payment life cycle management, product recommendations, a wishlist service, shopping cart, etc.</p>

<blockquote>
The fastest way to get started with microservices on the JVM platform is through <b>Spring Cloud Netflix</b> project which brings the Netflix components for building robust distributed systems. It provides a series of annotations for <b>Spring Boot</b> applications to save us from heavy lifting. Unfortunately, there is no integration for XML configuration model and I'm not really a Spring Boot fan (at least for now). I'm looking forward to see the support for templates and declarative programming model, maybe something based on <code>cloud-netflix</code> namespace, like <code> &lt;cloud-netflix:eureka-server host="home" port="8671" endpoint="eureka" /&gt;</code>

</blockquote>

<h3 id="service-discovery">Service discovery</h3>

<p>The service registration and discovery are one of the essential constructs of the microservice based architecture. There are a few service discovery and coordination servers on the market, like <a href="https://www.consul.io/">consul</a>,   <a href="https://coreos.com/etcd/">etcd</a>, <a href="https://zookeeper.apache.org/">zookeeper</a>, and the <a href="https://github.com/Netflix/eureka">Eureka</a> discovery server. The embedded Eureka server can be easily deployed by placing the <code>@EnableEurekaServer</code> annotation on the Spring Boot application. To test it yourself go to <a href="https://start.spring.io/">Spring Initializr</a> and generate a new Spring Boot application with <code>Eureka Server</code> starter support.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EurekaServerApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">EurekaServerApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>By default, the Eureka server will attempt to register itself as client too. To disable the client side registration use this settings in <code>application.yml</code></p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">eureka</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">client</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">registerWithEureka</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
    <span class="l-Scalar-Plain">fetchRegistry</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span></code></pre></div>

<p>After the server has started you can navigate to <code>http://localhost:8761</code> and explore the Eureka dashboard.</p>

<h4 id="creating-a-microservice">Creating a microservice</h4>
<p>We are now ready to create the actual microservice and register it within Eureka. If you still remember, the <em>todo</em> application stores the corresponding tasks in <strong>MongoDB</strong> and it exposes the operations via RESTful API. The microservice implementation is almost a replica of the code found in the monolithic application (see source code for details). Create another Spring Boot application skeleton with <code>Web</code>, <code>MongoDB</code> and <code>Eureka Discovery</code> starters. Annotate the Spring  Boot application’s main class with <code>@EnableEurekaClient</code> annotation to register the service instance and make it capable to query other registered services.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TodoMicroserviceApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">TodoMicroserviceApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>

<p>The following configuration in <code>application.yml</code> is required to locate the Eureka server and setup the MongoDB settings, like database name, port and the host where <code>mongod</code> process is listening for requests.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">spring</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">data</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">mongodb</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">27017</span>
      <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
      <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rabbit-todo</span>
<span class="l-Scalar-Plain">eureka</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">client</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">serviceUrl</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">defaultZone</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://localhost:8761/eureka/</span></code></pre></div>

<p>Once it has been deployed successfully, the microservice instance should appear in the Eureka dashboard.</p>

<h4 id="consuming-the-microservice">Consuming the microservice</h4>

<p>Spring Cloud Netflix makes it also trivial to access our registered microservices. An already well known <code>RestTemplate</code> abstraction can be used to consume the service API. Use <code>@Autowired</code> annotation to inject the template and Spring will configure it to be microservice aware (be able to locate the service by name).</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;/todos&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@ResponseBody</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">todos</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="s">&quot;http://todo-microservice/todos&quot;</span><span class="o">,</span>
    <span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">todos</span><span class="o">;</span>
<span class="o">}</span></code></pre></div>

<p>The code above queries the service registry to locate the <code>todo-microservice</code> service and request the available <em>todo</em> lists.</p>

<h3 id="gateway-and-routing">Gateway and routing</h3>

<p>Another important building block of the microservice architecture are the routing capabilities. It allows the web application to proxy the requests to the service by accessing the specified HTTP endpoint which is mapped to microservice identifier or the service registry URL. Spring Cloud ships with <strong>Zuul</strong> JVM router which is part of Netflix component’s suite. As you could guess, we can enable the embedded <strong>Zuul</strong> proxy by annotating the Spring Boot application’s main class with <code>@EnableZuulProxy</code>.
The definition of routing paths can be configured in the <code>application.yml</code>.</p>

<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">zuul</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">routes</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">todos</span><span class="p-Indicator">:</span>
       <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/api/v1/todo/**</span>
       <span class="l-Scalar-Plain">serviceId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">todo-microservice</span></code></pre></div>

<p>Any request matching the <code>/api/v1/todo/**</code> pattern is routed to the microservice instance with
<code>todo-microservice</code> identifier. We can rid off <code>TodoController</code> and see the UI is working as usual.
The benefits of this pattern go from centralized authentication, audit logging, global request interception, intelligent routing scenarios, the ability to apply the refactoring on the back end without altering any client specific entry point URL.</p>

<h3 id="circuit-breaker">Circuit breaker</h3>

<p>The last but not least pattern we are going to dissect is the circuit breaker. The safety and fault isolation are crucial in a cloud native microservice based architecture. We don’t want the malfunctioning services to compromise the rest of the infrastructure or trigger any cascading failures. To keep the code resilient in case of service crashes, Spring Cloud integrates with Netflix <strong>Hystrix</strong> failure isolator.
<code>@EnableCircuitBreaker</code> annotation arms the application with Hystrix circuit breaker. It’s trivial to connect our methods to the circuit breaker by annotating them with <code>@HystrixCommand</code> where we usually indicate the fallback method.</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;/todos&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="nd">@HystrixCommand</span><span class="o">(</span><span class="n">fallbackMethod</span> <span class="o">=</span> <span class="s">&quot;todosFallback&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">todos</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="s">&quot;http://todo-microservice/todos&quot;</span><span class="o">,</span> 
    <span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">todos</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="nf">todosFallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
<span class="o">}</span></code></pre></div>

<p>By default, Hystrix will open the circuit and prevent the call from being made
if there are 20 failures in the timespan of 5 seconds. If you want to see it in action, navigate to Hystrix dashboard after you had stopped the microservice. Try to make some calls by refreshing the page, and you’ll see the circuit being opened. As long as we have provided the fallback method, an empty list will be rendered in the browser.</p>

<h3 id="microservice-patterns-in-go">Microservice patterns in Go</h3>

<p>Although the JVM-based platforms are dominating the (microservice) architecture landscape, the <strong>Go</strong> language’s ecosystem is working its way up to enterprise.</p>

<p class="image-pull-right">
  <img width="300px" height="300px" src="/images/gopher.png" />
</p>

<p>It’s efficient, intuitive and with built-in concurrency support. It’s compiled but still feels like coding with dynamic programming language.</p>

<p>When it comes to microservice frameworks, I had found <a href="https://github.com/go-kit/kit">go-kit</a> and <a href="https://github.com/micro/go-micro">go-micro</a> the most feature rich ones. After some time of research I had opted for <strong>go-kit</strong>, even it doesn’t offer some useful features when it comes to service registration or the more sophisticated RESTful based transport. That’s why I ended up implementing both of them. Without further ado, let’s see the code.</p>

<p>I had advocated for service <a href="https://github.com/go-kit/kit/issues/167">registry capability</a> in go-kit, however, here is what I came up with (although this is a minimal implementation and definitely not production ready).</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ConsulRegistrator</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Config</span> <span class="o">*</span><span class="nx">consul</span><span class="p">.</span><span class="nx">Config</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">cr</span> <span class="o">*</span><span class="nx">ConsulRegistrator</span><span class="p">)</span> <span class="nx">Register</span><span class="p">(</span><span class="nx">service</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">port</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

    <span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">Config</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">cr</span><span class="p">.</span><span class="nx">Config</span> <span class="p">=</span> <span class="nx">consul</span><span class="p">.</span><span class="nx">DefaultConfig</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">consul</span><span class="p">.</span><span class="nx">NewClient</span><span class="p">(</span><span class="nx">cr</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>

    <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Agent</span><span class="p">().</span><span class="nx">ServiceRegister</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">consul</span><span class="p">.</span><span class="nx">AgentServiceRegistration</span><span class="p">{</span>
<<<<<<< HEAD
        <span class="nx">ID</span><span class="p">:</span> <span class="nx">service</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">port</span><span class="p">),</span>
=======
        <span class="nx">ID</span><span class="p">:</span> <span class="nx">service</span><span class="p">,</span>
>>>>>>> 78c2b4ab54dd198a8d186c30e3cacb20f6bd644b
        <span class="nx">Name</span><span class="p">:</span> <span class="nx">service</span><span class="p">,</span>
        <span class="nx">Port</span><span class="p">:</span> <span class="nx">port</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></div>

<p>The code can be found in <code>registry/consul</code> package (see the <a href="https://github.com/bhnedo/kit">fork</a>). Go-kit supports the HTTP transport out of the box. Although, there’s no way to create truly RESTful API as one we have built on Spring service. I figured out it was quite easy to wrap an existing go-kit endpoints with <strong>Gorilla</strong> routes.</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Demux</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
    <span class="nx">Mux</span> <span class="o">*</span><span class="nx">mux</span><span class="p">.</span><span class="nx">Router</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">demux</span> <span class="nx">Demux</span><span class="p">)</span> <span class="nx">NewRoute</span><span class="p">(</span>
    <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span>
    <span class="nx">e</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">,</span>
    <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span>
    <span class="nx">dec</span> <span class="nx">httptransport</span><span class="p">.</span><span class="nx">DecodeRequestFunc</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">handler</span> <span class="o">:=</span> <span class="nx">httptransport</span><span class="p">.</span><span class="nx">NewServer</span><span class="p">(</span>
      <span class="nx">demux</span><span class="p">.</span><span class="nx">Ctx</span><span class="p">,</span>
      <span class="nx">e</span><span class="p">,</span>
      <span class="nx">dec</span><span class="p">,</span>
      <span class="nx">encoder</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nx">route</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">handler</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">demux</span><span class="p">.</span><span class="nx">Mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">route</span><span class="p">).</span><span class="nx">Methods</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">encoder</span><span class="p">(</span><span class="nx">writer</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">response</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span><span class="p">(</span><span class="nx">writer</span><span class="p">).</span><span class="nx">Encode</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<h4 id="putting-the-pieces-together">Putting the pieces together</h4>

<p>In order to build a functional microservice adhere to these steps:</p>

<ul>
  <li>Create an interface / implementation which represents the business requirements for your service.</li>
</ul>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">TodoService</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nx">FindAll</span><span class="p">()</span> <span class="p">([]</span><span class="nx">Todo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">TodoServiceImpl</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">TodoRepo</span> <span class="nx">TodoRepository</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="nx">TodoServiceImpl</span><span class="p">)</span> <span class="nx">FindAll</span><span class="p">()</span> <span class="p">([]</span><span class="nx">Todo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">todos</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">TodoRepo</span><span class="p">.</span><span class="nx">FindAll</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">todos</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span></code></pre></div>

<ul>
  <li>Declare the request and response structs for every method in our interface.</li>
</ul>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">FindAllRequest</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">FindAllResponse</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Todos</span> <span class="p">[]</span><span class="nx">Todo</span> <span class="s">`json:&quot;todos&quot;`</span>
  <span class="nx">Err</span> <span class="kt">string</span> <span class="s">`json:&quot;err,omitempty&quot;`</span>
<span class="p">}</span></code></pre></div>

<ul>
  <li>Expose the endpoints. Every endpoint encapsulates the RPC method of our service. Having the Gorilla router integrated inside go-kit makes it trivial to publish the service interface.</li>
</ul>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">FindAllEndpoint</span><span class="p">(</span><span class="nx">service</span> <span class="nx">TodoService</span><span class="p">)</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">vars</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">todos</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">FindAll</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">FindResponse</span><span class="p">{[]</span><span class="nx">Todo</span><span class="p">{},</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">()},</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">FindResponse</span><span class="p">{</span><span class="nx">todos</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">},</span> <span class="kc">nil</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">dmx</span> <span class="o">:=</span> <span class="nx">demux</span><span class="p">.</span><span class="nx">Demux</span><span class="p">{</span><span class="nx">Ctx</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">Mux</span><span class="p">:</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">NewRouter</span><span class="p">()}</span>
<span class="nx">dmx</span><span class="p">.</span><span class="nx">NewRoute</span><span class="p">(</span><span class="s">&quot;/todos&quot;</span><span class="p">,</span> <span class="nx">todo</span><span class="p">.</span><span class="nx">FindAllEndpoint</span><span class="p">(</span><span class="nx">service</span><span class="p">),</span> <span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">decodeFindAllRequest</span><span class="p">)</span></code></pre></div>

<ul>
  <li>Finally, register the service in Consul discovery server. This allows the service instance to be discovered from Spring Boot app using the <strong>Spring Cloud Consul</strong> integrations.</li>
</ul>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="nx">cr</span> <span class="o">:=</span> <span class="nx">registrator</span><span class="p">.</span><span class="nx">ConsulRegistrator</span><span class="p">{</span><span class="nx">Config</span><span class="p">:</span> <span class="kc">nil</span><span class="p">}</span>

<span class="nx">err</span> <span class="o">:=</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="s">&quot;todo-microservice&quot;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<h3 id="the-synergy-of-a-polyglot-ecosystem">The synergy of a polyglot ecosystem</h3>

<p>The microservice architectures are often perceived as the next generation of <strong>SOA</strong>. I would also call it <strong>SOA on steroids</strong>. Well, in fact, they have a lot in common. Traditionally, most of the SOA services had been using <strong>SOAP</strong> as a standard data interchange protocol. Nowadays, the SOA based services can also communicate over <strong>REST</strong>, just like their microservice counterparts. We already know the microservices are language agnostic pieces. SOA based services can also coexist in a polyglot environment which is often orchestrated by <strong>ESB</strong> (Enterprise Service Bus) or the message broker.</p>

<p>Unlike microservices, SOA services are not aware of the single responsibility principle. The size and scope of the latter is measured in <strong>LOC</strong> (Lines of Code), not the functionalities they try to accomplish. Another subtle difference between microservices and SOA are their operational requirements. In a microservice world the <strong>PaaS</strong> solution and the <strong>DevOps</strong> culture are a must. The services have to be replicated over multiple nodes and they have to be able to scale in question of seconds. Another common practise is the packaging of microservices inside isolated execution environments known as containers (here is where Docker excels as the most popular implementation in the container ecosystem). From the point of view of <strong>technical</strong> changes, the operational requirements may be the most challenging factor for organizations when it comes to migrating from monolithic to microservice architectures.</p>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://rabbitstack.github.io/cloud/microservices/spring/a-pragmatic-approach-to-migration-from-monolithic-to-microservices/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://rabbitstack.github.io/cloud/microservices/spring/a-pragmatic-approach-to-migration-from-monolithic-to-microservices/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://rabbitstack.github.io/cloud/microservices/spring/a-pragmatic-approach-to-migration-from-monolithic-to-microservices/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>A pragmatic approach to migration from monolithic to microservices</strong> was published on <time datetime="2015-12-20T21:41:42+01:00">December 20, 2015</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread">
        
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'rabbitstack'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->
 
<div class="footer-wrap">
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://rabbitstack.github.io/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://rabbitstack.github.io/virtualization/of-unikernels-and-containers/" title="Of Unikernels and Containers">Of Unikernels and Containers</a></li>
    
      <li><a href="http://rabbitstack.github.io/angularjs/spring/mongodb/spring-mvc-angular-hasta-la-vista-jsp/" title="Spring MVC + Angular = Hasta la vista JSP!">Spring MVC + Angular = Hasta la vista JSP!</a></li>
    
      <li><a href="http://rabbitstack.github.io/spring/spring-boot-or-not-to-spring-boot/" title="Spring Boot or Not to Spring Boot?">Spring Boot or Not to Spring Boot?</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    

<span>&copy; 2016 Nedim Šabić. Rabbit Stack blog is powered by Jekyll. Bunny icon is courtesy of <a href="http://www.freepik.com" title="Freepik">Freepik.</a>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://rabbitstack.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://rabbitstack.github.io/assets/js/plugins/jquery.magnific-popup.js"></script>
<script src="http://rabbitstack.github.io/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'rabbitstack']);
  _gaq.push(['_trackPageview']);

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61212549-1', 'auto');
  ga('send', 'pageview');

  $(document).ready(function() {
     $('.image-popup').magnificPopup({type:'image'});
  });
</script>


  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'rabbitstack'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


	        

</body>
</html>
