<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Running a Storm cluster on SmartOS &#8211; Rabbit Stack</title>
<meta name="description" content="In a time when Storm was still developed and maintained by Twitter, I was working on small experiments in local cluster mode by processing social data from Facebook. It rained a lot since then, and Storm is now an active project under Apache umbrella.">
<meta name="keywords" content="cluster, SmartOS, Apache Storm, big data, zookeeper, nimbus, supervisor">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Running a Storm cluster on SmartOS">
<meta name="twitter:description" content="In a time when Storm was still developed and maintained by Twitter, I was working on small experiments in local cluster mode by processing social data from Facebook. It rained a lot since then, and Storm is now an active project under Apache umbrella.">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://rabbitstack.github.io/images/rabbit-bkgd.jpg">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Running a Storm cluster on SmartOS">
<meta property="og:description" content="In a time when Storm was still developed and maintained by Twitter, I was working on small experiments in local cluster mode by processing social data from Facebook. It rained a lot since then, and Storm is now an active project under Apache umbrella.">
<meta property="og:url" content="http://rabbitstack.github.io/storm/virtualization/running-a-storm-cluster-on-smartos/">
<meta property="og:site_name" content="Rabbit Stack">





<link rel="canonical" href="http://rabbitstack.github.io/storm/virtualization/running-a-storm-cluster-on-smartos/">
<link href="http://rabbitstack.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="Rabbit Stack Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://rabbitstack.github.io/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://rabbitstack.github.io/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://rabbitstack.github.io/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://rabbitstack.github.io/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://rabbitstack.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://rabbitstack.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://rabbitstack.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://rabbitstack.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://rabbitstack.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://rabbitstack.github.io/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
		<div class="site-name">
			<!-- <img src="/images/rabbit-small.jpg" alt="Rabbit Stack logo" class="logo" /> -->
			<!-- <a href="http://rabbitstack.github.io/">Rabbit Stack</a> -->
			<a href="http://rabbitstack.github.io/"><span class="site-name-segment">Rabbit</span> <span class="big-font">Stack</span></a>

		</div><!-- /.site-name -->

	
	
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				        
				    
				    <li><a href="http://rabbitstack.github.io#" >Home</a></li>
				
				    
				        
				    
				    <li><a href="http://rabbitstack.github.io/posts/" >Archive</a></li>
				
				    
				        
				    
				    <li><a href="http://rabbitstack.github.io/about/" >About</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->


  <div class="image-wrap">
  <img class="bkg" src=
    
      "http://rabbitstack.github.io/images/rabbit-bkgd.jpg"
    
  alt="Running a Storm cluster on SmartOS feature image">
  
       <div class="headline-wrap">
          <img src="http://rabbitstack.github.io/images/rabbitstack.png" />
          <h1> The place where bunnies dwell </h1>
          <h2> And bits become colossal </h2>
      </div>
  </div><!-- /.image-wrap -->


<div id="main" role="main">
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://rabbitstack.github.io/storm/virtualization/running-a-storm-cluster-on-smartos/" rel="bookmark" title="Running a Storm cluster on SmartOS">Running a Storm cluster on SmartOS</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>In a time when Storm was still developed and maintained by Twitter, I was working on small experiments in local cluster mode by processing social data from Facebook. It rained a lot since then, and Storm is now an active project under Apache umbrella. The curiosity of mine was eager to see how would the Storm operate in multi node deployment, so I decided to build a cluster on SmartOS hypervisor. I really adore SmartOS. It is so lightweight and it loads from the USB media. While the other hypervisors I've tried (XenServer, ESX) reserved the "huge" amount of RAM (on my 24 GB server XenServer was taking almost 4GB for the Dom0), SmartOS needs 200-300 MB of RAM. The provisioning of new virtual machines is really fast. You can run an OS level virtualization units called zones, or the KVM based virtual machines to run almost any legacy operating system (Linux, Windows, FreeBSD). You can learn more about SmartOS <a href="https://wiki.smartos.org/display/DOC/Home" target="_blank">here</a>. </p>
<p class="image-pull-right">
	<img src="/images/smartos+storm.png" />
</p>
<blockquote>
Are you new to Storm and you don't know what this is all about? Well apart from being a meteorological phenomenon, Storm is a distributed fault tolerant and realtime data stream processing platform. What Hadoop is for batch processing, Storm is for realtime data processing. There are two different type of nodes in Storm. The master node, also called as <code>nimbus</code> is responsible for assigning, monitoring and distributing tasks to worker or <code>supervisor</code> nodes in Storm terminology. In between there is a <code>ZooKeeper</code> node which is responsible for coordination and auto discovery of the nodes. The computation workflow is encapsulated into the unit called topology. It is basically a graph of <code>spouts</code>, components that represent the source of data streams and <code>bolts</code> which do some sort of processing on input streams and often generate new streams. For example we could have a spout which consumes Apache log messages from RabbitMQ queue, and one or more bolts which apply some kind of transformation, aggregation, or filtering logic. As our business demand increases, we also want to process a ton of logs from Tomcat and Nginx and one worker node won't deal well with it. No problem! Just spawn a desired number of worker nodes to scale horizontally, and Storm will make sure data processing is balanced and distributed accross the nodes. And what if one of the worker node fails? Don't panic! Storm is able to reschedule and assign the task to one of the healthy nodes ensuring fault-tolerant exactly-once messaging semantics processing. The image below shows the components of a Storm cluster.
</blockquote>

<figure>
  <a href="/images/storm.jpg" class="image-popup">
    <img src="/images/storm.jpg" />
  </a>
  <figcaption>Storm cluster</figcaption>
</figure>

<h3>Preparing SmartOS VMs</h3>

<p>Let’s first prepare the specifications for our SmartOS KVM virtual machines. I’ll use the Centos7 dataset to spawn Storm nodes. Find and import the image that corresponds to <code>centos-7</code> dataset.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>imgadm avail
...
c8c59f3c-a343-11e4-8e39-9360169bcaae  steelapp-developer      14.3.0      smartos  2015-01-23T21:07:03Z
02dbab66-a70a-11e4-819b-b3dc41b361d6  centos-7                <span class="m">20150128</span>    linux    2015-01-28T16:23:36Z
5becfd74-a70d-11e4-93a6-470507be237c  centos-6                <span class="m">20150128</span>    linux    2015-01-28T16:47:34Z
5f41692e-a70d-11e4-8c2d-afc6735144dc  debian-7                <span class="m">20150128</span>    linux    2015-01-28T16:47:40Z
...
<span class="nv">$ </span>imgadm import 02dbab66-a70a-11e4-819b-b3dc41b361d6</code></pre></div>

<p>The cluster will consist of these nodes:</p>
<ul>
	<li>1 <strong>ZooKeeper</strong> node with 1024 MB RAM and 1 VCPUs</li>
	<li>1 <strong>Nimbus</strong> node with 3048 MB RAM and 2 VCPUs</li>
	<li>3 <strong>Supervisor</strong> nodes with 4096 MB RAM and 3 VCPUs</li>
</ul>

<p>Here is a specification file for ZooKeeper node (you will need to change the network settings to match your environment). Save it as <code>centos7-zookeeper.json</code>.</p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;brand&quot;</span><span class="p">:</span> <span class="s2">&quot;kvm&quot;</span><span class="p">,</span>
  <span class="nt">&quot;resolvers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;8.8.4.4&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;ram&quot;</span><span class="p">:</span> <span class="s2">&quot;1024&quot;</span><span class="p">,</span>
  <span class="nt">&quot;vcpus&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;alias&quot;</span><span class="p">:</span> <span class="s2">&quot;zookeeper/0&quot;</span><span class="p">,</span>
  <span class="nt">&quot;nics&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;nic_tag&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
      <span class="nt">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.11&quot;</span><span class="p">,</span>
      <span class="nt">&quot;netmask&quot;</span><span class="p">:</span> <span class="s2">&quot;255.255.255.0&quot;</span><span class="p">,</span>
      <span class="nt">&quot;gateway&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.1&quot;</span><span class="p">,</span>
      <span class="nt">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;virtio&quot;</span><span class="p">,</span>
      <span class="nt">&quot;primary&quot;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;disks&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;image_uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;02dbab66-a70a-11e4-819b-b3dc41b361d6&quot;</span><span class="p">,</span>
      <span class="nt">&quot;boot&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nt">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;virtio&quot;</span><span class="p">,</span>
      <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">10000</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></div>

<p>The specifications for the Nimbus node is as follow. For the supervisor nodes we will basically use the same spec with some minor modifications.</p>

<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;brand&quot;</span><span class="p">:</span> <span class="s2">&quot;kvm&quot;</span><span class="p">,</span>
  <span class="nt">&quot;resolvers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;8.8.4.4&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;ram&quot;</span><span class="p">:</span> <span class="s2">&quot;3048&quot;</span><span class="p">,</span>
  <span class="nt">&quot;alias&quot;</span><span class="p">:</span> <span class="s2">&quot;nimbus/0&quot;</span><span class="p">,</span>
  <span class="nt">&quot;vcpus&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
  <span class="nt">&quot;nics&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;nic_tag&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
      <span class="nt">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.12&quot;</span><span class="p">,</span>
      <span class="nt">&quot;netmask&quot;</span><span class="p">:</span> <span class="s2">&quot;255.255.255.0&quot;</span><span class="p">,</span>
      <span class="nt">&quot;gateway&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.1&quot;</span><span class="p">,</span>
      <span class="nt">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;virtio&quot;</span><span class="p">,</span>
      <span class="nt">&quot;primary&quot;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;disks&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;image_uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;02dbab66-a70a-11e4-819b-b3dc41b361d6&quot;</span><span class="p">,</span>
      <span class="nt">&quot;boot&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nt">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;virtio&quot;</span><span class="p">,</span>
      <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">30000</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></div>

<h3>Installing ZooKeeper node</h3>

<p>Create a ZooKeeper VM from the spec file.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmadm create -f centos7-zookeeper.json</code></pre></div>

<p>Make sure you can login into your newly created VM. Now we will install the required dependencies. First, download and install JDK 7.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> /tmp
<span class="nv">$ </span>wget --no-check-certificate --no-cookies --header <span class="s2">&quot;Cookie: oraclelicense=accept-securebackup-cookie&quot;</span> http://download.oracle.com/otn-pub/java/jdk/7u75-b13/jdk-7u75-linux-x64.tar.gz
<span class="nv">$ </span>tar -xvf jdk-7u75-linux-x64.tar.gz
<span class="nv">$ </span>mv /usr/lib/jvm/java-7-oracle

<span class="nv">$ </span>vi /etc/profile
<span class="nv">$ </span><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/lib/jvm/java-7-oracle
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/lib/jvm/java-7-oracle/bin

<span class="nv">$ </span><span class="nb">source</span> /etc/profile</code></pre></div>

<p>Next, install ZooKeeper packages from the Cloudera repository.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vi /etc/yum.repos.d/Cloudera.repo

<span class="o">[</span>cloudera-cdh4<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>cloudera-cdh4
<span class="nv">baseurl</span><span class="o">=</span>http://archive.cloudera.com/cdh4/redhat/6/x86_64/cdh/4/
<span class="nv">gpgkey</span> <span class="o">=</span> http://archive.cloudera.com/cdh4/redhat/6/x86_64/cdh/RPM-GPG-KEY-cloudera
<span class="nv">gpgcheck</span> <span class="o">=</span> 1

<span class="nv">$ </span>yum install zookeeper zookeeper-server</code></pre></div>

<p>If the installation went successful we are ready to configure ZooKeeper. It is important to enable the regular purging of old data and transaction logs, otherwise ZooKeeper will eat all of your disk space. Edit the configuration file.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vi /etc/zookeeper/conf/zoo.cfg

autopurge.purgeInterval<span class="o">=</span>12
autopurge.snapRetainCount<span class="o">=</span>5</code></pre></div>

<p>Update the <code>/etc/hosts</code> file to include ZooKeeper’s hostname.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vi /etc/hosts
192.168.1.11 zookeeper0</code></pre></div>

<p>Finally we can start the ZooKeeper and verify it’s working as expected. Run these commands.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>/usr/lib/zookeeper/bin/zkServer.sh start
<span class="nv">$ </span><span class="nb">echo </span>ruok <span class="p">|</span> nc zookeeper0 2181
imok</code></pre></div>

<p>It is of crucial importance to run ZooKeeper under supervision, since ZooKeeper will terminate if it encounters any error. To achieve it you can use a number of process monitoring tools like <a href="http://mmonit.com/monit/" target="_blank">monit</a>, <a href="http://supervisord.org/" target="_blank">supervisord</a>, or <a href="http://godrb.com/" target="_blank">god</a>.</p>

<h3>Deploying Nimbus node</h3>

<p>First, provision a new virtual machine for the Nimbus node.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmadm create -f centos7-nimbus.json</code></pre></div>

<p>The following steps apply for both, the Nimbus and the Supervisor nodes, so once we had the required dependencies installed, we will create the snapshot that later on can be used to provision the Supervisor nodes. Note that here is also important to run Nimbus and Supervisor daemons under supervision.</p>

<h4>Download and install JDK 7</h4>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> /tmp
<span class="nv">$ </span>wget --no-check-certificate --no-cookies --header <span class="s2">&quot;Cookie: oraclelicense=accept-securebackup-cookie&quot;</span> http://download.oracle.com/otn-pub/java/jdk/7u75-b13/jdk-7u75-linux-x64.tar.gz
<span class="nv">$ </span>tar -xvf jdk-7u75-linux-x64.tar.gz
<span class="nv">$ </span>mv /usr/lib/jvm/java-7-oracle

<span class="nv">$ </span>vi /etc/profile
<span class="nv">$ </span><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/lib/jvm/java-7-oracle
<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/lib/jvm/java-7-oracle/bin

<span class="nv">$ </span><span class="nb">source</span> /etc/profile</code></pre></div>

<h4>Install ZeroMQ</h4>

<p> Add the following repository to install the ZeroMQ package. </p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vi /etc/yum.repos.d/ZeroMQ.repo

<span class="o">[</span>home_fengshuo_zeromq<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>The latest stable of zeromq builds <span class="o">(</span>CentOS_CentOS-6<span class="o">)</span>
<span class="nb">type</span><span class="o">=</span>rpm-md
<span class="nv">baseurl</span><span class="o">=</span>http://download.opensuse.org/repositories/home:/fengshuo:/zeromq/CentOS_CentOS-6/
<span class="nv">gpgcheck</span><span class="o">=</span>1
<span class="nv">gpgkey</span><span class="o">=</span>http://download.opensuse.org/repositories/home:/fengshuo:/zeromq/CentOS_CentOS-6/repodata/repomd.xml.key
<span class="nv">enabled</span><span class="o">=</span>1

<span class="nv">$ </span>yum install zeromq zeromq-devel</code></pre></div>

<h4>Install JZMQ</h4>

<p>JZMQ are the Java bindings for the ZeroMQ messaging framework. As we are going to compile and build JZMQ from sources, some dependencies are needed. Install them first.

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>yum install libtool gcc autoconf automake gcc-c++</code></pre></div>


<p>Now we can download and install JZMQ.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> /tmp
<span class="nv">$ </span>wget https://github.com/zeromq/jzmq/archive/master.zip
<span class="nv">$ </span><span class="nb">cd </span>jzmq-master

<span class="nv">$ </span>./autogen.sh
<span class="nv">$ </span>./configure
<span class="nv">$ </span>make
<span class="nv">$ </span>make install</code></pre></div>


<h4>Create Storm system user and group</h4>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>groupadd -g <span class="m">53001</span> storm
<span class="nv">$ </span>mkdir /var/lib/storm
<span class="nv">$ </span>useradd -u <span class="m">53001</span> -g <span class="m">53001</span> -d /var/lib/storm/ -s /bin/bash storm -c <span class="s2">&quot;Storm user&quot;</span>
<span class="nv">$ </span>chown -R storm:storm /var/lib/storm/
<span class="nv">$ </span>chmod <span class="m">750</span> /var/lib/storm</code></pre></div>


<h4>Download and install Apache Storm</h4>

<p>Download the latest version of Storm - <strong>0.9.3</strong> at the time of writing. Decompress the tarball and move it to the <code>/usr/local</code> directory.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>wget http://ftp.cixug.es/apache/storm/apache-storm-0.9.3/apache-storm-0.9.3.tar.gz
<span class="nv">$ </span>tar -xvf apache-storm-0.9.3.tar.gz
<span class="nv">$ </span>mv apache-storm-0.9.3 /usr/local/
<span class="nv">$ </span><span class="nb">cd</span> /usr/local
<span class="nv">$ </span>mv apache-storm-0.9.3 storm
<span class="nv">$ </span>chown -R storm:storm /usr/local/storm/</code></pre></div>


<h4>Configure Storm</h4>

<p>Add ZooKeeper and Nimbus nodes to the <code>hosts</code> file.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vi /etc/hosts
192.168.1.11 zookeeper0
192.168.1.12 nimbus/0</code></pre></div>

<p>Now edit the Storm configuration file. You need to add the ZooKeeper server/s, the Nimbus node, and change the path where Storm will store a small amount of state data.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vi /usr/local/storm/conf/storm.yaml

storm.zookeeper.servers:
      - <span class="s2">&quot;zookeeper0&quot;</span>

nimbus.host: <span class="s2">&quot;nimbus/0&quot;</span>

nimbus.childopts: <span class="s2">&quot;-Xmx1024m -Djava.net.preferIPv4Stack=true&quot;</span>
ui.childopts: <span class="s2">&quot;-Xmx768m -Djava.net.preferIPv4Stack=true&quot;</span>
supervisor.childopts: <span class="s2">&quot;-Djava.net.preferIPv4Stack=true&quot;</span>
worker.childopts: <span class="s2">&quot;-Xmx768m -Djava.net.preferIPv4Stack=true&quot;</span>

storm.local.dir: <span class="s2">&quot;/var/lib/storm&quot;</span></code></pre></div>


<h4>Build the snapshot</h4>

<p>Before we proceed with snapshotting, halt the Nimbus virtual machine.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmadm stop ab09289c-c05a-4c41-92ec-025b367bc860</code></pre></div>


<p>Now make the snapshot of disk0 <i>zvol</i> which pertains to Nimbus dataset. Dump and compress the dataset.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>zfs snapshot zones/ab09289c-c05a-4c41-92ec-025b367bc860-disk0@image
<span class="nv">$ </span>zfs send zones/ab09289c-c05a-4c41-92ec-025b367bc860-disk0@image <span class="p">|</span> gzip &gt; supervisor.zvol.gz</code></pre></div>


<p>To import the dataset that can be used as the template for the Supervisor node provisioning it is necessary to build the image manifest. Generate a random UUID and get the SHA1 hash of the supervisor dataset by running these commands.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>uuid
<span class="nv">$ </span>digest -v -a sha1 supervisor.zvol.gz</code></pre></div>


<p>We will also need the size of the dataset expressed in bytes.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ls -ltr <span class="p">|</span> grep supervisor.zvol.gz <span class="p">|</span> awk <span class="s1">&#39;{print $5}&#39;</span>
859618398</code></pre></div>


<p>With that information in hand we can create an image manifest file and import the dataset.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vi /var/manifests/supervisor.dsmanifest</code></pre></div>


<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;1d94a2ec-cfe0-11e4-a9be-9b1c2d718bba&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;centos7-supervisor&quot;</span><span class="p">,</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Base template to provision Storm supervisor nodes&quot;</span><span class="p">,</span>
    <span class="nt">&quot;v&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>

    <span class="nt">&quot;os&quot;</span><span class="p">:</span> <span class="s2">&quot;linux&quot;</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;zvol&quot;</span><span class="p">,</span>
    <span class="nt">&quot;platform_type&quot;</span><span class="p">:</span> <span class="s2">&quot;smartos&quot;</span><span class="p">,</span>

    <span class="nt">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-03-21T09:09Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-03-21T09:09Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;published_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-03-21T09:09Z&quot;</span><span class="p">,</span>
    <span class="nt">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/supervisor.zvol.gz&quot;</span><span class="p">,</span>
        <span class="nt">&quot;sha1&quot;</span><span class="p">:</span> <span class="s2">&quot;12b6ae88372eab0697f0bba3038a4c9fc0a94a7f&quot;</span><span class="p">,</span>
        <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">859618398</span><span class="p">,</span>
        <span class="nt">&quot;compression&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip&quot;</span>
     <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;disk_driver&quot;</span><span class="p">:</span> <span class="s2">&quot;virtio&quot;</span><span class="p">,</span>
    <span class="nt">&quot;image_size&quot;</span><span class="p">:</span> <span class="s2">&quot;10240&quot;</span>
<span class="p">}</span></code></pre></div>



<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>imgadm install -m /var/manifests/supervisor.dsmanifest -f /var/supervisor.zvol.gz
Installing image 1d94a2ec-cfe0-11e4-a9be-9b1c2d718bba <span class="o">(</span>centos7-supervisor@1.0.0<span class="o">)</span>
<span class="o">[=======================================================</span>&gt;<span class="o">]</span> 100% 819.80MB  31.36MB/s    26s
Installed image 1d94a2ec-cfe0-11e4-a9be-9b1c2d718bba <span class="o">(</span>centos7-supervisor@1.0.0<span class="o">)</span></code></pre></div>


<h3>Provisioning Supervisor nodes</h3>

<p>With the dataset imported we can start provisioning the Supervisor nodes using the slightly modified version of the Nimbus node specification file.</p>


<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;brand&quot;</span><span class="p">:</span> <span class="s2">&quot;kvm&quot;</span><span class="p">,</span>
  <span class="nt">&quot;resolvers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;8.8.4.4&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;ram&quot;</span><span class="p">:</span> <span class="s2">&quot;4096&quot;</span><span class="p">,</span>
  <span class="nt">&quot;alias&quot;</span><span class="p">:</span> <span class="s2">&quot;supervisor/0&quot;</span><span class="p">,</span>
  <span class="nt">&quot;vcpus&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
  <span class="nt">&quot;nics&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;nic_tag&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
      <span class="nt">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.14&quot;</span><span class="p">,</span>
      <span class="nt">&quot;netmask&quot;</span><span class="p">:</span> <span class="s2">&quot;255.255.255.0&quot;</span><span class="p">,</span>
      <span class="nt">&quot;gateway&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.1&quot;</span><span class="p">,</span>
      <span class="nt">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;virtio&quot;</span><span class="p">,</span>
      <span class="nt">&quot;primary&quot;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;disks&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;image_uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;1d94a2ec-cfe0-11e4-a9be-9b1c2d718bba&quot;</span><span class="p">,</span>
      <span class="nt">&quot;boot&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nt">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;virtio&quot;</span><span class="p">,</span>
      <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">50000</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></div>


<p>Note that we have changed the <code>image_uuid</code> to point to our imported dataset, and we have assigned the Supervisor node more memory, disk and one additional CPU. Now we can easily deploy and scale the worker nodes.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmadm create -f centos7-supervisor.json</code></pre></div>


<p>This is the output of <code>vmadm list</code> on my SmartOS instance.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>vmadm list

UUID                                  TYPE  RAM      STATE             ALIAS
05af15b2-f8ae-4918-807c-ed9a3a57d522  KVM   <span class="m">1024</span>     running           zookeeper/0
8d8bb235-3826-46bb-88e4-f96cdc182faa  KVM   <span class="m">3048</span>     running           nimbus/0
8b4dce58-4fdc-45f5-8439-389e7b095b45  KVM   <span class="m">4096</span>     running           supervisor/1
ab09289c-c05a-4c41-92ec-025b367bc860  KVM   <span class="m">4096</span>     running           supervisor/0
eb5c80fd-1174-4c40-8818-38565fc09d5a  KVM   <span class="m">4096</span>     running           supervisor/2</code></pre></div>


<h3>Submitting the topology</h3>

<p>I assume you've run <code>/usr/local/storm/bin/storm nimbus</code> and <code>/usr/local/storm/bin/storm supervisor</code> daemons under supervision. To test the cluster, we are going to deploy a simple topology from the <code>storm-starter</code> project. Run these commands on the Nimbus node. Start by cloning the Storm repository.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> /root
<span class="nv">$ </span>git clone git://github.com/apache/storm.git</code></pre></div>


<p>Go to <code>storm/examples/storm-starter</code> directory and build the topology jar using Maven.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>storm/examples/storm-starter
<span class="nv">$ </span>mvn clean install -DskipTests<span class="o">=</span><span class="nb">true</span></code></pre></div>


<p>Finally, submit the topology to the Storm cluster.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>target
<span class="nv">$ </span>/usr/local/storm/bin/storm jar storm-starter-0.10.0-SNAPSHOT.jar storm.starter.ExclamationTopology exclamation-topology

Running: /usr/lib/jvm/java-7-oracle/bin/java -client -Dstorm.options<span class="o">=</span> -Dstorm.home<span class="o">=</span>/usr/local/storm -Dstorm.log.dir<span class="o">=</span>/usr/local/storm/logs
...
<span class="m">2539</span> <span class="o">[</span>main<span class="o">]</span> INFO  backtype.storm.StormSubmitter - Jar not uploaded to master yet. Submitting jar...
<span class="m">2553</span> <span class="o">[</span>main<span class="o">]</span> INFO  backtype.storm.StormSubmitter - Uploading topology jar storm-starter-0.10.0-SNAPSHOT.jar to assigned location: /var/lib/storm/nimbus/inbox/stormjar-30afcd84-fd2e-4463-8275-8ff0133eff15.jar
Start uploading file <span class="s1">&#39;storm-starter-0.10.0-SNAPSHOT.jar&#39;</span> to <span class="s1">&#39;/var/lib/storm/nimbus/inbox/stormjar-30afcd84-fd2e-4463-8275-8ff0133eff15.jar&#39;</span> <span class="o">(</span><span class="m">152705</span> bytes<span class="o">)</span>
<span class="o">[==================================================]</span> <span class="m">152705</span> / 152705
File <span class="s1">&#39;storm-starter-0.10.0-SNAPSHOT.jar&#39;</span> uploaded to <span class="s1">&#39;/var/lib/storm/nimbus/inbox/stormjar-30afcd84-fd2e-4463-8275-8ff0133eff15.jar&#39;</span> <span class="o">(</span><span class="m">152705</span> bytes<span class="o">)</span>
<span class="m">2576</span> <span class="o">[</span>main<span class="o">]</span> INFO  backtype.storm.StormSubmitter - Successfully uploaded topology jar to assigned location: /var/lib/storm/nimbus/inbox/stormjar-30afcd84-fd2e-4463-8275-8ff0133eff15.jar
<span class="m">2576</span> <span class="o">[</span>main<span class="o">]</span> INFO  backtype.storm.StormSubmitter - Submitting topology exclamation-topology in distributed mode with conf <span class="o">{</span><span class="s2">&quot;topology.workers&quot;</span>:3,<span class="s2">&quot;topology.debug&quot;</span>:true<span class="o">}</span>
<span class="m">2716</span> <span class="o">[</span>main<span class="o">]</span> INFO  backtype.storm.StormSubmitter - Finished submitting topology: exclamation-topology</code></pre></div>


<p> You can get detailed stats about the cluster infrastructure, configuration, topology execution, etc. from the Storm UI. Start the server.</p>


<div class="highlight"><pre><code class="language-bash" data-lang="bash">/usr/local/storm/bin/storm ui</code></pre></div>


<p>Direct your browser to <code>http://numbus_node_ip:8080</code>.</p>

<figure>
  <a href="/images/storm-ui.jpg" class="image-popup">
    <img src="/images/storm-ui.jpg" />
  </a>
  <figcaption>Storm UI</figcaption>
</figure>
</p>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://rabbitstack.github.io/storm/virtualization/running-a-storm-cluster-on-smartos/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://rabbitstack.github.io/storm/virtualization/running-a-storm-cluster-on-smartos/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://rabbitstack.github.io/storm/virtualization/running-a-storm-cluster-on-smartos/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>Running a Storm cluster on SmartOS</strong> was published on <time datetime="2015-03-21T21:35:37+01:00">March 21, 2015</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread">
        
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'rabbitstack'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://rabbitstack.github.io/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://rabbitstack.github.io/operating%20systems/fibratus-0-7-0/" title="Fibratus 0.7.0">Fibratus 0.7.0</a></li>
    
      <li><a href="http://rabbitstack.github.io/operating%20systems/fibratus-0-6-0/" title="Fibratus 0.6.0">Fibratus 0.6.0</a></li>
    
      <li><a href="http://rabbitstack.github.io/operating%20systems/fibratus-0-4-0/" title="Fibratus 0.4.0">Fibratus 0.4.0</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->

  <footer>
    

<span>&copy; 2017 Nedim Šabić. Rabbit Stack blog is powered by Jekyll. Bunny icon is courtesy of <a href="http://www.freepik.com" title="Freepik">Freepik.</a>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://rabbitstack.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://rabbitstack.github.io/assets/js/plugins/jquery.magnific-popup.js"></script>
<script src="http://rabbitstack.github.io/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'rabbitstack']);
  _gaq.push(['_trackPageview']);

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61212549-1', 'auto');
  ga('send', 'pageview');

  $(document).ready(function() {
     $('.image-popup').magnificPopup({type:'image'});
  });
</script>


  
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'rabbitstack'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




</body>
</html>
